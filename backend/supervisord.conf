[supervisord]
nodaemon=true                   ; Run supervisor in the foreground, which is required for Docker.
logfile=/dev/null               ; Redirect supervisor's own log to null (we'll log to stdout).
logfile_maxbytes=0              ; Disable log rotation for the supervisor log.
pidfile=/tmp/supervisord.pid    ; Location of the PID file.

; ==============================================================================
; 1. GUNICORN WEB SERVER (for the FastAPI API)
; ==============================================================================
[program:gunicorn]
; The command to start the main API server.
; - It uses the `app` object from the `main.py` file inside the `app` package.
; - `-w 4` starts 4 worker processes (a good starting point, adjust based on CPU cores).
; - `-k uvicorn.workers.UvicornWorker` tells Gunicorn to use Uvicorn for handling async requests.
; - `--bind 0.0.0.0:%(ENV_PORT)s` binds to all network interfaces on the port provided by the environment (e.g., Hugging Face or AWS Fargate).
command=gunicorn -w 4 -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:%(ENV_PORT)s

priority=1                      ; Start Gunicorn first.
autostart=true                  ; Start this program automatically when supervisor starts.
autorestart=true                ; Automatically restart the program if it exits unexpectedly.
stdout_logfile=/dev/stdout      ; Redirect the program's standard output to the container's stdout.
stdout_logfile_maxbytes=0       ; Disable log rotation for stdout.
stderr_logfile=/dev/stderr      ; Redirect the program's standard error to the container's stderr.
stderr_logfile_maxbytes=0       ; Disable log rotation for stderr.

; ==============================================================================
; 2. CELERY BACKGROUND WORKER
; ==============================================================================
[program:celery_worker]
; The command to start the Celery worker.
; - `-A app.celery_worker` points to the Celery app instance.
; - `-l info` sets the logging level.
; - `-Q ...` specifies which queues this worker should listen to.
; - `--pool=prefork` is the default and generally best for CPU-bound tasks.
command=celery -A app.celery_worker worker -l info -Q long_running,high_priority,default --pool=prefork

priority=2                      ; Start the Celery worker after Gunicorn.
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ==============================================================================
; 3. (Optional) CELERY BEAT SCHEDULER
; ==============================================================================
; Uncomment this section if you need to run periodic tasks (e.g., a nightly report).
; Your `celery_worker.py` would need to be configured with a beat_schedule.
;
; [program:celery_beat]
; command=celery -A app.celery_worker beat -l info
; priority=3
; autostart=true
; autorestart=true
; stdout_logfile=/dev/stdout
; stdout_logfile_maxbytes=0
; stderr_logfile=/dev/stderr
; stderr_logfile_maxbytes=0